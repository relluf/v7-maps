<template><div class="page">
	<div class="navbar">
	    <div class="navbar-inner">
	        <div class="left sliding"></div>
	        <div class="title sliding">{{l "-title"}}</div>
	        <div class="right sliding">
	        	<a class="submit-changes link">{{l "Apply"}}</a>
	        </div>
	    </div>
	</div>
	<div class="page-content">
		<div class="center">
			<div id="Modem-serial" class="title">{{Modem.serial()}}</div>
			<div id="Modem-type" class="subtitle">{{Modem.type()}}</div>
			<span>{{Modem.location()}}</span>
		</div>
		
		<div class="block-title">{{l "Modem-hardware.header"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><div class="item-content">
				<div class="item-media">
					<i class="fa fa-fw fa-battery-three-quarters menu-icon bg-color-green"></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						<div class="item-header">{{l "Setting/currentbattery"}}</div>{{Modem.currentbattery()}}
					</div>
				</div>
			</div></li>
			<li><a href="/settings/newbattery/" class="item-content item-link">
				<div class="item-media invisible">
					<i class="fa fa-fw fa-battery-three-quarters menu-icon bg-color-green"></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						{{l "Setting/newbattery.label"}}
					</div>
					<div id="Modem-newbattery" class="item-after"></div>
				</div>
			</a></li>
			{{#if Modem.ext_eswsensor_enabled}}
			<li class=""><a href="/settings/topport/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-dashboard menu-icon bg-color-green"></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						{{l "Setting/topport.label"}}
						<div class="item-footer ext_eswsensor-required required">{{l "Setting/ext_eswsensor.required"}}</div>
						<div class="ext_eswsensor-custom">
							<div class="item-footer powersupply-required required">{{l "Setting/ext_powersupply.required"}}</div>
							<div class="item-footer interfacetype-required required">{{l "Setting/ext_interfacetype.required"}}</div>
						</div>
					</div>
					<div id="Modem-ext_eswsensor" class="item-after">{{Modem.ext_eswsensor()}}</div>
				</div>
			</a></li>
			{{/if}}
		</ul></div>

		<div class="block-title">{{l "Modem-hardware.header"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><a href="/settings/battery/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-battery-three-quarters menu-icon bg-color-green"></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						{{l "Setting/battery.label"}}
						<div class="item-footer battery-required required">{{l "Setting/battery.required"}}</div>
					</div>
					<div id="Modem-battery" class="item-after">{{Modem.battery()}}</div>
				</div>
			</a></li>
			{{#if Modem.ext_eswsensor_enabled}}
			<li><a href="/settings/topport/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-dashboard menu-icon bg-color-green"></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						{{l "Setting/ext_eswsensor.label"}}
						<div class="item-footer ext_eswsensor-required required">{{l "Setting/ext_eswsensor.required"}}</div>
						<div class="ext_eswsensor-custom">
							<div class="item-footer powersupply-required required">{{l "Setting/ext_powersupply.required"}}</div>
							<div class="item-footer interfacetype-required required">{{l "Setting/ext_interfacetype.required"}}</div>
						</div>
					</div>
					<div id="Modem-ext_eswsensor" class="item-after">{{Modem.ext_eswsensor()}}</div>
				</div>
			</a></li>
			{{/if}}
		</ul></div>

		<div class="block-title">{{l "Setting/location.header"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><a href="/settings/location/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-map-signs menu-icon bg-color-yellow "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/location.label"}}</div>
					<div id="Modem-location" class="item-after">{{Modem.location()}}</div>
				</div>
			</a></li>
		</ul></div>

		<div class="block-title">{{l "Interval.plural"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><a href="/settings/interval/send/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-send-o menu-icon bg-color-blue "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">
						{{l "Setting/sendinterval"}}
						<!--<div class="item-footer requested">Requested: Once a day</div>-->
					</div>
					<div id="Modem-sendinterval" class="item-after">{{Modem.sendinterval()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/interval/wakeup/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-bell-o menu-icon bg-color-blue "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/wakeupinterval"}}</div>
					<div id="Modem-wakeupinterval" class="item-after">{{Modem.wakeupinterval()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/interval/barolog/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-bold menu-icon bg-color-blue "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/barologinterval"}}</div>
					<div id="Modem-barologinterval" class="item-after">{{Modem.barologinterval()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/interval/sample/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-bold menu-icon bg-color-blue "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/sampleinterval"}}</div>
					<div id="Modem-sampleinterval" class="item-after">{{Modem.sampleinterval()}}</div>
				</div>
			</a></li>
		</ul></div>
		
		<div class="block-title">{{l "Setting/allportsic.header"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><a href="/settings/allportsic/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-line-chart menu-icon bg-color-pink "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/allportsic.label"}}</div>
					<div id="Modem-allportsic" class="item-after">{{Modem.allportsic()}}</div>
				</div>
			</a></li>
		</ul></div>
		
		<div class="block-title">{{l "Setting/email.plural"}}</div>
		<div class="list item-after-shrink"><ul>
			<li><a href="/settings/emailaddress/1/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-vcard menu-icon bg-color-orange "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/emailaddress1"}}</div>
					<div id="Modem-emailaddress1" class="item-after">{{Modem.emailaddress1()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/emailaddress/2/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-vcard-o menu-icon bg-color-orange "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/emailaddress2"}}</div>
					<div id="Modem-emailaddress2" class="item-after">{{Modem.emailaddress2()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/emailaddress/3/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-vcard menu-icon bg-color-orange "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/emailaddress3"}}</div>
					<div id="Modem-emailaddress3" class="item-after">{{Modem.emailaddress3()}}</div>
				</div>
			</a></li>
			<li><a href="/settings/emailaddress/4/" class="item-content item-link">
				<div class="item-media">
					<i class="fa fa-fw fa-at menu-icon bg-color-orange "></i>
				</div>
				<div class="item-inner">
					<div class="item-title">{{l "Setting/emailaddress4"}}</div>
					<div id="Modem-emailaddress4" class="item-after">{{Modem.emailaddress4()}}</div>
				</div>
			</a></li>
		</ul></div>

		<div class="block hidden">
			<div class="center">{{l "Modem-hardwareVersion"}}: {{hardwareversion}}</div>
			<div class="center">{{l "Modem-softwareVersion"}}: {{softwareversion}}</div>
		</div>

		<div class="button-block" style="margin-bottom:50px;">
			<a class="button button-big button-round submit-changes2">{{l "Apply"}}</a>
			<a class="button button-big button-round revert">{{l "Revert"}}</a>
		</div>
		
	</div>
</div></template>
<script>
	var Modem = {};
	["serial", "type", "location", "currentbattery", "ext_eswsensor", "battery", "ext_eswsensor", "location", "sendinterval", "wakeupinterval", "barologinterval", "sampleinterval", "allportsic", "emailaddress1", "emailaddress2", "emailaddress3", "emailaddress4"].forEach(key => Modem[key] = (function() { return key; }));
	return {
		data: function() { return { Modem: Modem } }
	};
//# sourceURL=pages/Main.html#script
	var ajax = require("jquery").ajax;
	var refresh = require("refreshDom");
	var Controller = require("pages/Controller");
	
	function submit() {
		var modem = window.app_data.Modem;
		var values = modem._values;
		
		/*- #4717: If modem available in TCN then:
			- A: Detect change in battery
			- B: Detect change in TopSensor/Output/PowerSupply
			- C: Detect customer wants new page (not applicable
			- D: (modem has synced with BO) --> B
		*/
		var detected = values.original.tcn && ["battery", "ext_eswsensor", "ext_interfacetype", "ext_powersupply"].some(_ => values.requested.hasOwnProperty(_));
			
		function post() {
			var dialog = app.dialog.preloader(locale("Working"));
			var requested = js.mixIn({}, values.requested);
			if(requested.hasOwnProperty("location")) {
				requested.modemlocation = requested.location;
				delete requested.location;
			}
			if(requested.hasOwnProperty("battery")) {
				requested.newbattery = requested.battery;
				delete requested.battery;
			}
			var parameters = {};
			Object.keys(requested).filter(_ => _.indexOf("topportparameter-") === 0).forEach(function(parameter) {
				var name = parameter.substring("topportparameter-".length);
				parameters[name] = requested[parameter];
				delete requested[parameter];
				requested.topportparameters = parameters;
			});

			if(modem._values.requested.ext_eswsensor !== 1) {
				// console.log("removed ext_interfacetype and ext_powersupply")
				delete requested.ext_interfacetype;
				delete requested.ext_powersupply;
			}
			ajax({
				url: window.app_data.rest_uri + "settings",
				method: "POST",
				contentType: "application/json",
				data: JSON.stringify(requested)
			})
				.then(function(resp) {
					dialog.close(); 
					if(Object.keys(resp.rejected).length) {
				        var msg = [], feedback = resp.rejected;
				        for(var k in feedback) {
				            msg.push("<b>" + k + "</b>: " + feedback[k].reason);
				        }
						app.dialog.alert(String.format(
								window.locale("Setting.requestsNotAccepted"), 
								msg.join("</li><li>")), locale("Alert"));
					} else {
						app.dialog.alert(
							locale("Application.willReload"), 
							locale("Ready"), 
							function() {
								window.location.reload();
							});
					}
				})
				.fail(function(e) {
					dialog.close(); 
					app.dialog.alert(String.format(
						window.locale("Setting.requestsNotAccepted"), 
						e.responseText), locale("Alert"))
				});
		}
		
		if(detected === false) {
			return post();
		}
		
		app.dialog.create({
			title: locale("Setting/requestconfirmconfiguration.title"),
			text: String.format(locale("Setting/requestconfirmconfiguration.query")),
			buttons: [{
				text: locale("Yes"), 
				onClick: function() {
					values.requested.requestconfirmconfiguration = true;
					post();
				}
			}, {
				text: locale("No"),
				onClick: function() {
					post();
				}
			}, {
				text: locale("Cancel")
			}]
		}).open();
	}	
	
	return Controller.create({handlers: {
		afterin: refresh,
		beforein: refresh,
		navbar: { ".submit-changes click": submit },
		".submit-changes2 click": submit,
		".revert click": function() { window.location.reload(); }
	}});	
</script>
<style>

.hidden { display: none; }
.invisible {visibility: hidden; }

.page-content .list .item-footer.required {
	font-weight: bold;
	color: red;
}
.page-content .list .item-inner .changed { 
	color: #007aff; 
	font-weight: bold;
}

</style>