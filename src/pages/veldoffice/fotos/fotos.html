<template><div class="page fotos page-with-subnavbar">
	<div class="navbar">
		<div class="navbar-inner sliding navbar-current">
			<div class="left"><a class="link back">
				<i class="icon icon-back"></i>
				<span class="ios-only">{{l "Back"}}</span>
			</a></div>
			<div class="title">{{l "Foto.plural.title"}}</div>
			<div class="subnavbar">
				<form data-search-container=".virtual-list" data-search-item="li" data-search-in=".item-title" class="searchbar searchbar-init">
					<div class="searchbar-inner">
						<div class="searchbar-input-wrap">
							<input type="search" placeholder="{{l 'Search.placeholder'}}">
							<i class="searchbar-icon"></i>
							<span class="input-clear-button"></span>
						</div>
						<span class="searchbar-disable-button">{{l "Cancel"}}</span>
					</div>
				</form>
			</div>
		</div>
	</div>	
	<div class="searchbar-backdrop"></div>
	<div class="page-content hide-navbar-on-scroll infinite-scroll-content ptr-content">
	    <div class="ptr-preloader">
			<div class="preloader"></div>
			<div class="ptr-arrow"></div>
	    </div>
	    <div class="block searchbar-hide-on-search">
			<p>{{l "Foto.search-label"}}</p>
		</div>
		<div class="list onderzoek virtual-list searchbar-found media-list">
		</div>
		<div class="list searchbar-not-found">
			<ul><li class="item-content"><div class="item-inner">
				<div class="item-title">{{l "NothingFound"}}</div>
			</div></li></ul>
		</div>
		<div class="search-on-server">
			<div class="button-block">
				<a class="flex1"></a>
				<a class="button flex5 login button-raised button-big button-fil">{{l "Search-on-server"}}</a>
				<a class="flex1"></a>
			</div>
		</div>
	    <div class="preloader infinite-scroll-preloader searchbar-hide-on-search"></div>
	</div>
</div></template>
<script>

//# sourceURL=pages/investigations

	var template = require("text!pages/investigations-template.html");
	var Session = require("veldoffice/Session");
	var EM = require("veldoffice/EM");
	var moment = require("moment");

	var cache = require("pages/cache/investigations"), arr = [];
	var $$ = Dom7;
	var page_n = 0;
	
	function match(onderzoek, query) {
		return query.split(" ").some(function(query) {
			if(0 && query.indexOf("count-meetpunt") === 0) {
				return onderzoek.count_valid_meetpunten >= parseInt(query.split(":")[1], 10);
			}
			
			return ["projectcode", "naam", "bedrijf"].some(function(key) {
				var str = onderzoek[key];
				return typeof str === "string" 
					&& str.toLowerCase().indexOf(query.toLowerCase()) !== -1;
			});
		});
	}
	function getPage(page) {
		if(page < cache.pages.length) {
			return Promise.resolve(cache.pages[page]);
		}

		return Promise.all([
			EM.query("Onderzoek", [
					"countdistinct:[outer]fotos.id count_fotos",
					"countdistinct:[outer]meetpunten.id count_meetpunten",
					// "countdistinct:[outer]labopdrachten.id count_labopdrachten",
					"[outer]bedrijf.naam bedrijf_naam", 
					"id", "naam", "projectcode", "contour",
					"created", "modified", "status", "methode"
				], {
					page: [page, 50],
					groupBy: "id", 
					orderBy: "modified desc",
					// having: ["countdistinct:[outer]meetpunten.id"]
				}).then(function(res) {
					return cache.pages[page] = res;
				}),
			
			EM.query("Onderzoek", "id,count:meetpunten.id count_meetpunten_with_coords", { orderBy:"modified desc", groupBy: "id", where:["and", ["isnotnull", "meetpunten.xcoord"], ["isnotnull", "meetpunten.ycoord"]]})
			
		]).then(function(results) {
			return results[0];
		})
			
	}
	
	function nextPage() {
		var pages = cache.pages;
		return getPage(page_n).then(function(res) {
			if(pages === cache.pages) { // if no ptr/refresh has occured
				res.forEach(_ => { 
					_.page = page_n; 
					_.modified_moment = moment(_.modified).calendar();
				});
				page_n++;
				arr.splice.apply(arr, [arr.length, 0].concat(res));
			}
			return res;
		});
	}
		
	return { on: {
		pageInit(e) {
			var f7page = e.target.f7Page;

			$$(".search-on-server", e.target).addClass("display-none");
			
			e.target.up(".view").down(".searchbar").on({
				"searchbar:enable": function(e) {
					$$(".search-on-server").removeClass("display-none");
				},
				"searchbar:disable": function(e) {
					$$(".search-on-server").addClass("display-none");
				}
			})

			var ptr = e.target.qs(".ptr-content");
			ptr.on("ptr:refresh", function(e) {
				var sb = f7a.searchbar.get(e.target.up(".view").down(".searchbar"));
				if(sb.enabled) {
					// f7a.ptr.done(ptr);	
					// return;
				}
				
				cache.pages = []; page_n = 0;
				// TODO cancel current request if any
				nextPage().then(function(res) {
					arr.splice.apply(arr, [0, arr.length].concat(res));
					f7a.ptr.done(ptr);	
					f7a.virtualList.get(e.target.qs(".virtual-list")).update(true);
				});
			});
			
			e.target.qs(".virtual-list").on("click", function(e) {
				var li = e.target.up("li");
				if(li) {
					f7page.router.navigate("/investigation?key=" + li.dataset.key);
				}
			});
			e.target.qs(".infinite-scroll-content").on("infinite", function() {
				if(!e.target.hasOwnProperty("infinite-busy")) {
					e.target['infinite-busy'] = Date.now();
					nextPage().then(function() {
						delete e.target['infinite-busy'];
						f7a.virtualList.get(e.target.qs(".virtual-list")).update();
					});
				}
			});
			
			nextPage().then(function() { 
				f7a.virtualList.create({
					el: e.target.qs(".virtual-list"),
			    	cache: true,
			    	rowsAfter: 10,
			    	rowsBefore: 10,
			        items: arr,
			        itemTemplate: template,
			        searchAll: function(query, items) {
			            var found = [];
			            for (var i = 0; i < items.length; i++) {
			                if (query.trim() === '' || match(items[i], query)) {
			                    found.push(i);
			                }
			            }
			            // $$(".count", this.node).html(found.length);
			            return found;
			        },
			        height: 105
			    });
			});
		}
	} };

</script>
<style>
</style>